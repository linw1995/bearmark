# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working
with code in this repository.

## Architecture Overview

Bearmark is a browser bookmark management system built with Rust, consisting
of multiple workspace packages:

- **bearmark-api**: Main API server using Rocket framework with PostgreSQL
  database
- **bearmark-web**: Frontend web application built with Leptos (WASM-based)
- **bearmark-ql**: Query language parsing for search functionality
- **bearmark-macro**: Procedural macros for code generation

The system provides REST APIs for bookmark management with folder
organization, tagging, and search capabilities. It includes auto-generated
OpenAPI documentation and embedded web UI.

## Development Environment Setup

### Prerequisites

- Use Nix for development environment: `nix develop` or `direnv` for automatic
  loading
- PostgreSQL database (via Docker Compose)

### Initial Setup

```bash
# Setup development environment and database
./scripts/cli.sh setup

# Install development dependencies
./scripts/cli.sh install-deps
```

### Environment Configuration

- Development uses `.envrc` file generated by setup script
- Database configuration via `BM_DATABASES` environment variable
- Uses Diesel for database migrations and ORM

## Common Development Commands

### Building and Running

```bash
# Run API server (default port 8000)
./scripts/cli.sh serve

# Build web frontend (Leptos/WASM)
trunk serve  # Development server on port 1420
trunk build  # Production build
```

### Testing and Quality Assurance

```bash
# Run all tests
./scripts/cli.sh test

# Run linting (clippy)
./scripts/cli.sh lint

# Generate test coverage report
./scripts/cli.sh coverage
```

### Database Operations

```bash
# Open database console
./scripts/cli.sh db-console

# Run migrations (handled automatically by setup)
diesel migration run
```

### Development Workflow Cleanup

```bash
# Stop development environment
./scripts/cli.sh teardown
```

## Database Schema and Migrations

- Database schema located at: `bearmark-api/src/db/schema.rs`
- Migrations in `migrations/` directory
- Uses Diesel ORM with async PostgreSQL support
- Schema includes tables for bookmarks, folders, tags, and relationships

## API Structure

### Core API Endpoints

- `/api/bookmarks` - Bookmark CRUD operations
- `/api/folders` - Folder management
- `/api/tags` - Tag management
- `/swagger-ui/` - Interactive API documentation

### Key Components

- Authentication via API keys
- Query language parsing for advanced search
- Folder hierarchy support
- Tag-based organization
- OpenAPI specification generation

## Frontend Architecture

The web frontend (`bearmark-web`) uses:

- Leptos framework for reactive UI
- WASM compilation target
- Trunk for build tooling
- Embedded within the API server when deployed

## Cross-Platform Building

```bash
# Cross-compile for Linux (musl)
nix develop .#x86_64-unknown-linux-musl
cargo build --target x86_64-unknown-linux-musl --release \
  --package bearmark-api --bin serve
```

## Deployment

- Docker Compose deployment available in `deployments/docker-compose/`
- Pre-built container images at `ghcr.io/linw1995/bearmark`
- Supports API key authentication
- HTTPS recommended for production use
