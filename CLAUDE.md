# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working
with code in this repository.

## Architecture Overview

Bearmark is a browser bookmark management system built with Rust, consisting
of multiple workspace packages:

- **bearmark-api**: Main API server using Rocket framework with PostgreSQL
  database
- **bearmark-web**: Frontend web application built with Leptos (WASM-based)
- **bearmark-ql**: Query language parsing for search functionality
- **bearmark-macro**: Procedural macros for code generation

The system provides REST APIs for bookmark management with folder
organization, tagging, and search capabilities. It includes auto-generated
OpenAPI documentation and embedded web UI.

## Development Environment Setup

### Prerequisites

- Use Nix for development environment: `nix develop` or `direnv` for automatic
  loading
- PostgreSQL database (via Docker Compose)

### Initial Setup

```bash
# Setup development environment and database
./scripts/cli.sh setup

# Install development dependencies
./scripts/cli.sh install-deps
```

### Environment Configuration

- Development uses `.envrc` file generated by setup script
- Database configuration via `BM_DATABASES` environment variable
- Uses Diesel for database migrations and ORM
- Web UI serving via `BM_UI_PATH` environment variable (optional)

## Common Development Commands

### Building and Running

```bash
# Run API server only (default port 8000)
./scripts/cli.sh serve

# Build web frontend (Leptos/WASM) - MUST run from project root
trunk build  # Production build to dist/ (run from project root, not bearmark-web directory)

# Run API server with integrated web UI (port 8000)
export BM_UI_PATH=./dist
./scripts/cli.sh serve
# OR use single command:
BM_UI_PATH=./dist ./scripts/cli.sh serve

# Development workflow with hot-reload
trunk serve  # Web UI development server on port 1420 (run from project root)
./scripts/cli.sh serve  # API server on port 8000 (separate terminal)

# Complete development workflow (recommended)
# 1. Build web frontend first: trunk build
# 2. Start integrated server: BM_UI_PATH=./dist ./scripts/cli.sh serve
# 3. Access web UI at: http://localhost:8000/
```

### Testing and Quality Assurance

```bash
# Run all tests
./scripts/cli.sh test

# Run linting (clippy)
./scripts/cli.sh lint

# Generate test coverage report
./scripts/cli.sh coverage
```

### Database Operations

```bash
# Open database console
./scripts/cli.sh db-console

# Run migrations (handled automatically by setup)
diesel migration run
```

### Development Workflow Cleanup

```bash
# Stop development environment
./scripts/cli.sh teardown
```

## Database Schema and Migrations

- Database schema located at: `bearmark-api/src/db/schema.rs`
- Migrations in `migrations/` directory
- Uses Diesel ORM with async PostgreSQL support
- Schema includes tables for bookmarks, folders, tags, and relationships

## API Structure

### Framework

- **bearmark-api** uses Rocket.rs as the web framework
- For detailed Rocket.rs documentation and examples, use MCP Context7 to search `/rwf2/rocket`

### Core API Endpoints

- `/api/bookmarks` - Bookmark CRUD operations
- `/api/folders` - Folder management
- `/api/tags` - Tag management
- `/swagger-ui/` - Interactive API documentation

### Key Components

- Authentication via API keys
- Query language parsing for advanced search
- Folder hierarchy support
- Tag-based organization
- OpenAPI specification generation

## Frontend Architecture

The web frontend (`bearmark-web`) uses:

- Leptos framework for reactive UI
- WASM compilation target
- Trunk for build tooling
- Served by the API server via Rocket's FileServer

### Integration Details

- Build artifacts are generated in `dist/` directory
- API server serves static files when `BM_UI_PATH` is configured
- Web UI is mounted at root path `/` alongside API routes at `/api/*`
- Supports both development (hot-reload) and production (integrated) modes
- **IMPORTANT**: All trunk commands (`trunk build`, `trunk serve`) must be run from project root directory, not from `bearmark-web/` subdirectory
- **bearmark-web depends on bearmark-api**: The web frontend requires the API server to be running to fetch data from `/api/*` endpoints

## Cross-Platform Building

```bash
# Cross-compile for Linux (musl)
nix develop .#x86_64-unknown-linux-musl
cargo build --target x86_64-unknown-linux-musl --release \
  --package bearmark-api --bin serve
```

## Deployment

- Docker Compose deployment available in `deployments/docker-compose/`
- Pre-built container images at `ghcr.io/linw1995/bearmark`
- Supports API key authentication
- HTTPS recommended for production use

### Web UI Deployment

- Set `BM_UI_PATH` environment variable to serve static files
- Container includes pre-built web assets in `./static`
- Access web interface at server root path (e.g., `http://localhost:2284/`)
- API remains accessible at `/api/*` endpoints
